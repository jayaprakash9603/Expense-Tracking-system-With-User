// Jenkins Pipeline with Docker Support
// Builds services and creates Docker images

pipeline {
    agent any
    
    tools {
        maven 'Maven-3.9.0'
        jdk 'JDK-17'
    }
    
    environment {
        MAVEN_OPTS = '-Xmx3072m -XX:MaxPermSize=512m'
        BACKEND_ROOT = 'Expense-tracking-System-backend/Expense-tracking-backend-main'
        DOCKER_REGISTRY = 'your-docker-registry' // Update this
        BUILD_TIMESTAMP = sh(script: "date '+%Y%m%d-%H%M%S'", returnStdout: true).trim()
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 90, unit: 'MINUTES')
        timestamps()
    }
    
    parameters {
        booleanParam(name: 'SKIP_TESTS', defaultValue: true, description: 'Skip tests')
        booleanParam(name: 'BUILD_DOCKER_IMAGES', defaultValue: false, description: 'Build Docker images')
        booleanParam(name: 'PUSH_TO_REGISTRY', defaultValue: false, description: 'Push to Docker registry')
        string(name: 'DOCKER_TAG', defaultValue: 'latest', description: 'Docker image tag')
    }
    
    stages {
        stage('ğŸ” Validation') {
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "ğŸš€ Expense Tracker - Docker Build Pipeline"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    sh 'mvn --version'
                    sh 'java -version'
                    
                    if (params.BUILD_DOCKER_IMAGES) {
                        sh 'docker --version'
                    }
                }
            }
        }
        
        stage('ğŸ—ï¸ Build Maven Projects') {
            parallel {
                stage('Core Services') {
                    stages {
                        stage('Eureka Server') {
                            steps { buildMavenProject('eureka-server') }
                        }
                        stage('Gateway') {
                            steps { buildMavenProject('Gateway') }
                        }
                        stage('User Service') {
                            steps { buildMavenProject('user-service') }
                        }
                        stage('Social Media App') {
                            steps { buildMavenProject('social-media-app') }
                        }
                    }
                }
                
                stage('Business Services') {
                    stages {
                        stage('Budget Service') {
                            steps { buildMavenProject('Budget-Service') }
                        }
                        stage('Category Service') {
                            steps { buildMavenProject('Category-Service') }
                        }
                        stage('Payment Method') {
                            steps { buildMavenProject('Payment-method-Service') }
                        }
                        stage('Bill Service') {
                            steps { buildMavenProject('Bill-Service') }
                        }
                    }
                }
                
                stage('Support Services') {
                    stages {
                        stage('Notification') {
                            steps { buildMavenProject('Notification-Service') }
                        }
                        stage('Friendship') {
                            steps { buildMavenProject('FriendShip-Service') }
                        }
                        stage('Chat') {
                            steps { buildMavenProject('Chat-Service') }
                        }
                        stage('Event') {
                            steps { buildMavenProject('Event-Service') }
                        }
                        stage('Audit') {
                            steps { buildMavenProject('Audit-Service') }
                        }
                        stage('Analytics') {
                            steps { buildMavenProject('AnalyticsService') }
                        }
                    }
                }
            }
        }
        
        stage('ğŸ³ Build Docker Images') {
            when {
                expression { params.BUILD_DOCKER_IMAGES }
            }
            steps {
                script {
                    def services = getServicesList()
                    
                    services.each { service ->
                        buildDockerImage(service, params.DOCKER_TAG)
                    }
                }
            }
        }
        
        stage('ğŸ“¤ Push to Registry') {
            when {
                expression { params.PUSH_TO_REGISTRY && params.BUILD_DOCKER_IMAGES }
            }
            steps {
                script {
                    def services = getServicesList()
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-registry-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh "echo ${DOCKER_PASS} | docker login -u ${DOCKER_USER} --password-stdin ${DOCKER_REGISTRY}"
                        
                        services.each { service ->
                            def imageName = "${DOCKER_REGISTRY}/expense-tracker-${service}:${params.DOCKER_TAG}"
                            sh "docker push ${imageName}"
                            echo "âœ… Pushed: ${imageName}"
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“¦ Archive Artifacts') {
            steps {
                script {
                    archiveArtifacts artifacts: "${BACKEND_ROOT}/**/target/*.jar",
                                   allowEmptyArchive: true,
                                   fingerprint: true
                    
                    // Create build summary
                    def summary = """
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    BUILD SUMMARY
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    Build Number: #${BUILD_NUMBER}
                    Timestamp: ${BUILD_TIMESTAMP}
                    Docker Tag: ${params.DOCKER_TAG}
                    Tests Skipped: ${params.SKIP_TESTS}
                    Docker Images: ${params.BUILD_DOCKER_IMAGES}
                    Registry Push: ${params.PUSH_TO_REGISTRY}
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    writeFile file: 'build-summary.txt', text: summary
                    archiveArtifacts artifacts: 'build-summary.txt'
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘       âœ… BUILD SUCCESSFUL! âœ…              â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                
                if (params.BUILD_DOCKER_IMAGES) {
                    echo "ğŸ³ Docker images built successfully"
                }
                if (params.PUSH_TO_REGISTRY) {
                    echo "ğŸ“¤ Images pushed to registry"
                }
            }
        }
        
        failure {
            script {
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘         âŒ BUILD FAILED! âŒ                â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
        }
        
        always {
            cleanWs(
                cleanWhenNotBuilt: false,
                deleteDirs: true,
                disableDeferredWipeout: true,
                patterns: [[pattern: '**/target', type: 'INCLUDE']]
            )
        }
    }
}

// Helper Functions
def buildMavenProject(String serviceName) {
    def startTime = System.currentTimeMillis()
    
    dir("${BACKEND_ROOT}/${serviceName}") {
        if (fileExists('pom.xml')) {
            echo "ğŸ”¨ Building ${serviceName}..."
            
            def cleanPhase = params.CLEAN_BUILD ? 'clean' : ''
            def testSkip = params.SKIP_TESTS ? '-DskipTests' : ''
            
            sh "mvn ${cleanPhase} package ${testSkip} --batch-mode --errors"
            
            def endTime = System.currentTimeMillis()
            def duration = (endTime - startTime) / 1000
            
            echo "âœ… ${serviceName} completed in ${duration}s"
        } else {
            echo "âš ï¸ No pom.xml for ${serviceName}"
        }
    }
}

def buildDockerImage(String serviceName, String tag) {
    dir("${BACKEND_ROOT}/${serviceName}") {
        if (fileExists('Dockerfile')) {
            def imageName = "${DOCKER_REGISTRY}/expense-tracker-${serviceName}:${tag}"
            
            echo "ğŸ³ Building Docker image: ${imageName}"
            sh "docker build -t ${imageName} ."
            
            // Also tag as build number
            sh "docker tag ${imageName} ${DOCKER_REGISTRY}/expense-tracker-${serviceName}:${BUILD_NUMBER}"
            
            echo "âœ… Docker image built: ${imageName}"
        } else {
            echo "âš ï¸ No Dockerfile for ${serviceName}"
        }
    }
}

def getServicesList() {
    return [
        'eureka-server',
        'Gateway',
        'user-service',
        'social-media-app',
        'Budget-Service',
        'Category-Service',
        'Payment-method-Service',
        'Bill-Service',
        'Notification-Service',
        'FriendShip-Service',
        'Chat-Service',
        'Event-Service',
        'Audit-Service',
        'AnalyticsService'
    ]
}
