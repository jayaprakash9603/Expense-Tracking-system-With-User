pipeline {
    agent any
    
    tools {
        maven 'Maven-3.9.0' // Configure this in Jenkins Global Tool Configuration
        jdk 'JDK-17'        // Configure this in Jenkins Global Tool Configuration
    }
    
   environment {
    // Maven configuration (Java 8+ compatible)
    MAVEN_OPTS = '-Xmx3072m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m -Djava.awt.headless=true'
    MAVEN_CLI_OPTS = '--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true'
    
    // Build configuration
    SKIP_TESTS = 'true'
    PARALLEL_BUILD = 'true'
    
    // Logging
    BUILD_TIMESTAMP = bat(script: "@echo %date:~-4,4%-%date:~-10,2%-%date:~-7,2%_%time:~0,2%-%time:~3,2%-%time:~6,2%", returnStdout: true).trim()
    LOG_LEVEL = 'INFO'
}
    
    options {
        // Keep builds for 30 days or last 10 builds
        buildDiscarder(logRotator(numToKeepStr: '10', daysToKeepStr: '30'))
        
        // Timeout for entire pipeline
        timeout(time: 60, unit: 'MINUTES')
        
        // Disable concurrent builds
        disableConcurrentBuilds()
        
        // Add timestamps to console output
        timestamps()
    }
    
    parameters {
        string(
            name: 'BACKEND_BASE_PATH',
            defaultValue: 'C:\\Users\\jayapraj\\Downloads\\Expense-Tracking-system-With-User\\Expense-tracking-System-backend\\Expense-tracking-backend-main',
            description: 'Absolute path to backend services directory'
        )
        booleanParam(
            name: 'SKIP_TESTS', 
            defaultValue: true, 
            description: 'Skip running tests during build'
        )
        booleanParam(
            name: 'CLEAN_BUILD', 
            defaultValue: true, 
            description: 'Perform clean build (mvn clean)'
        )
        booleanParam(
            name: 'BUILD_ALL_SERVICES', 
            defaultValue: true, 
            description: 'Build all services in parallel'
        )
        choice( 
            name: 'LOG_LEVEL', 
            choices: ['INFO', 'DEBUG', 'WARN', 'ERROR'], 
            description: 'Maven build log level'
        )
    }
    
    stages {
        stage('ğŸ“‹ Initialization') {
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "ğŸš€ EXPENSE TRACKER BACKEND SERVICES - BUILD PIPELINE"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "ğŸ“… Build Date: ${BUILD_TIMESTAMP}"
                    echo "ğŸ”§ Jenkins Build: #${BUILD_NUMBER}"
                    echo "ğŸŒ¿ Branch: ${env.GIT_BRANCH ?: 'N/A'}"
                    echo "ğŸ‘¤ Started by: ${currentBuild.getBuildCauses()[0]?.userId ?: 'System'}"
                    echo "âš™ï¸  Skip Tests: ${params.SKIP_TESTS}"
                    echo "ğŸ§¹ Clean Build: ${params.CLEAN_BUILD}"
                    echo "ğŸ“Š Log Level: ${params.LOG_LEVEL}"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Set dynamic environment variables
                    env.SKIP_TESTS = params.SKIP_TESTS
                    env.CLEAN_BUILD = params.CLEAN_BUILD
                    env.LOG_LEVEL = params.LOG_LEVEL
                }
            }
        }
        
        stage('ğŸ” Pre-Build Validation') {
            steps {
                script {
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘               PRE-BUILD VALIDATION                         â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Check Maven installation
                    echo "âœ“ Checking Maven installation..."
                    bat 'mvn --version'
                    
                    // Check Java installation
                    echo "âœ“ Checking Java installation..."
                    bat 'java -version'
                    
                    // Check workspace
                    echo "âœ“ Checking backend base path..."
                    echo "ğŸ“‚ Backend Path: ${params.BACKEND_BASE_PATH}"
                    bat "dir \"${params.BACKEND_BASE_PATH}\" /b"
                    
                    echo "âœ… Pre-build validation completed successfully"
                }
            }
        }
        
        stage('ğŸ—ï¸  Build Services') {
            when {
                expression { params.BUILD_ALL_SERVICES }
            }
            parallel {
                stage('ğŸ” User Service') {
                    steps {
                        script {
                            buildService('user-service', 'ğŸ”')
                        }
                    }
                }
                
                stage('ğŸ“± Social Media App') {
                    steps {
                        script {
                            buildService('social-media-app', 'ğŸ“±')
                        }
                    }
                }
                
                stage('ğŸŒ Eureka Server') {
                    steps {
                        script {
                            buildService('eureka-server', 'ğŸŒ')
                        }
                    }
                }
                
                stage('ğŸšª Gateway') {
                    steps {
                        script {
                            buildService('Gateway', 'ğŸšª')
                        }
                    }
                }
                
                stage('ğŸ’° Budget Service') {
                    steps {
                        script {
                            buildService('Budget-Service', 'ğŸ’°')
                        }
                    }
                }
                
                stage('ğŸ“‹ Category Service') {
                    steps {
                        script {
                            buildService('Category-Service', 'ğŸ“‹')
                        }
                    }
                }
                
                stage('ğŸ’³ Payment Method Service') {
                    steps {
                        script {
                            buildService('Payment-method-Service', 'ğŸ’³')
                        }
                    }
                }
                
                stage('ğŸ§¾ Bill Service') {
                    steps {
                        script {
                            buildService('Bill-Service', 'ğŸ§¾')
                        }
                    }
                }
                
                stage('ğŸ”” Notification Service') {
                    steps {
                        script {
                            buildService('Notification-Service', 'ğŸ””')
                        }
                    }
                }
                
                stage('ğŸ‘¥ Friendship Service') {
                    steps {
                        script {
                            buildService('FriendShip-Service', 'ğŸ‘¥')
                        }
                    }
                }
                
                stage('ğŸ’¬ Chat Service') {
                    steps {
                        script {
                            buildService('Chat-Service', 'ğŸ’¬')
                        }
                    }
                }
                
                stage('ğŸ“… Event Service') {
                    steps {
                        script {
                            buildService('Event-Service', 'ğŸ“…')
                        }
                    }
                }
                
                stage('ğŸ” Audit Service') {
                    steps {
                        script {
                            buildService('Audit-Service', 'ğŸ”')
                        }
                    }
                }
                
                stage('ğŸ“Š Analytics Service') {
                    steps {
                        script {
                            buildService('AnalyticsService', 'ğŸ“Š')
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“¦ Artifact Collection') {
            steps {
                script {
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘              COLLECTING BUILD ARTIFACTS                    â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    def services = [
                        'user-service', 'social-media-app', 'eureka-server', 'Gateway',
                        'Budget-Service', 'Category-Service', 'Payment-method-Service',
                        'Bill-Service', 'Notification-Service', 'FriendShip-Service',
                        'Chat-Service', 'Event-Service', 'Audit-Service', 'AnalyticsService'
                    ]
                    
                    services.each { service ->
                        def jarPath = "${params.BACKEND_BASE_PATH}\\${service}\\target\\*.jar"
                        def jarExists = bat(
                            script: "@echo off & if exist \"${jarPath}\" (echo FOUND) else (echo NOTFOUND)",
                            returnStdout: true
                        ).trim()
                        
                        if (jarExists.contains('FOUND')) {
                            echo "âœ“ ${service}: JAR found"
                            archiveArtifacts artifacts: "${params.BACKEND_BASE_PATH}\\${service}\\target\\*.jar", 
                                           allowEmptyArchive: true,
                                           fingerprint: true
                        } else {
                            echo "âš  ${service}: No JAR file found (might be a POM project)"
                        }
                    }
                    
                    echo "âœ… Artifact collection completed"
                }
            }
        }
        
        stage('ğŸ“Š Build Summary') {
            steps {
                script {
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                   BUILD SUMMARY                            â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    try {
                        // Safe calculation
                        long buildDurationMillis = currentBuild.duration ?: 0
                        long buildDurationSeconds = buildDurationMillis / 1000L
                        long minutes = buildDurationSeconds / 60L
                        long seconds = buildDurationSeconds % 60L
                        
                        echo "â±ï¸  Total Build Time: ${minutes}m ${seconds}s"
                        echo "ğŸ“Š Build Status: ${currentBuild.result ?: 'SUCCESS'}"
                        echo "ğŸ”¢ Build Number: #${BUILD_NUMBER}"
                        echo "ğŸ“… Timestamp: ${BUILD_TIMESTAMP}"
                        echo ""
                        echo "âœ… All services built successfully!"
                    } catch (Exception e) {
                        echo "âš ï¸  Could not calculate build duration: ${e.message}"
                    }
                    
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
            }
        }
        
        stage('ğŸ“ Copy JARs to Downloads') {
            steps {
                script {
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘            COPYING JARS TO DOWNLOADS FOLDER                â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Create timestamp for folder name
                    def timestamp = new Date().format('yyyyMMdd_HHmmss')
                    def outputFolder = "C:\\Users\\jayapraj\\Downloads\\expense-tracker-jars-${timestamp}"
                    
                    echo "ğŸ“‚ Creating output folder: ${outputFolder}"
                    bat "mkdir \"${outputFolder}\""
                    
                    def services = [
                        'user-service', 'social-media-app', 'eureka-server', 'Gateway',
                        'Budget-Service', 'Category-Service', 'Payment-method-Service',
                        'Bill-Service', 'Notification-Service', 'FriendShip-Service',
                        'Chat-Service', 'Event-Service', 'Audit-Service', 'AnalyticsService'
                    ]
                    
                    def copiedCount = 0
                    
                    services.each { service ->
                        def sourcePath = "${params.BACKEND_BASE_PATH}\\${service}\\target"
                        echo "ğŸ” Checking ${service}..."
                        
                        // Check if target folder exists
                        def targetExists = bat(
                            script: "@echo off & if exist \"${sourcePath}\" (echo EXISTS) else (echo NOTFOUND)",
                            returnStdout: true
                        ).trim()
                        
                        if (targetExists.contains('EXISTS')) {
                            // Copy all JAR files from this service
                            def copyResult = bat(
                                script: "@echo off & xcopy \"${sourcePath}\\*.jar\" \"${outputFolder}\\\" /Y /Q 2>nul & echo COPIED",
                                returnStatus: true
                            )
                            
                            if (copyResult == 0) {
                                echo "âœ… ${service}: JAR copied"
                                copiedCount++
                            } else {
                                echo "âš ï¸  ${service}: No JAR file found or copy failed"
                            }
                        } else {
                            echo "âš ï¸  ${service}: Target folder not found"
                        }
                    }
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                    COPY COMPLETE                           â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "ğŸ“Š Total JARs copied: ${copiedCount}"
                    echo "ğŸ“‚ Location: ${outputFolder}"
                    
                    // Create batch file to run all services
                    echo ""
                    echo "ğŸ“ Creating batch file to run all services..."
                    
                    def batContent = """@echo off
REM ===============================================================================
REM  Expense Tracker - Run All Microservices
REM  This script assumes it is in the same directory as all the JAR files.
REM  It will start all microservices in the correct order.
REM ===============================================================================

setlocal enabledelayedexpansion

REM Get the directory where this batch file is located. This is where the JARs should be.
set "JAR_DIR=%~dp0"

REM Remove trailing backslash if present
if "%JAR_DIR:~-1%"=="\\" set "JAR_DIR=%JAR_DIR:~0,-1%"

echo.
echo ========================================================================
echo   Expense Tracker Microservices Launcher
echo ========================================================================
echo.
echo [INFO] Running from JAR Directory: %JAR_DIR%
echo.

REM Check if Java is installed
java -version >nul 2>&1
if %ERRORLEVEL% NEQ 0 (
    echo [ERROR] Java is not installed or not in PATH!
    echo Please install Java 17 or higher and try again.
    pause
    exit /b 1
)

echo [INFO] Java found. Starting services...
echo.

REM Set Java options for all services
set JAVA_OPTS=-Xms256m -Xmx512m

REM Check if Windows Terminal is available
where wt >nul 2>nul
if %ERRORLEVEL% EQU 0 (
    echo [INFO] Windows Terminal detected. Starting services in new tabs...
    echo.
    
    REM Start all services in Windows Terminal with multiple tabs, ensuring we are in the correct directory
    start "" wt new-tab --title "Eureka Server" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar eureka-server-0.0.1.jar" ^
    ; new-tab --title "API Gateway" cmd /k "cd /d "%JAR_DIR%" && timeout /t 30 /nobreak && java %JAVA_OPTS% -jar gateway-0.0.1-SNAPSHOT.jar" ^
    ; new-tab --title "User Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 50 /nobreak && java %JAVA_OPTS% -jar User-service-0.0.1.jar" ^
    ; new-tab --title "Expense Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 50 /nobreak && java %JAVA_OPTS% -jar expenses-service-0.0.1.jar" ^
    ; new-tab --title "Category Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 55 /nobreak && java %JAVA_OPTS% -jar Category-Service-0.0.1-SNAPSHOT.jar" ^
    ; new-tab --title "Payment Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 55 /nobreak && java %JAVA_OPTS% -jar Payment-Method-0.0.1-SNAPSHOT.jar" ^
    ; new-tab --title "Budget Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 60 /nobreak && java %JAVA_OPTS% -jar Budget-Service-0.0.1-SNAPSHOT.jar" ^
    ; new-tab --title "Bill Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 60 /nobreak && java %JAVA_OPTS% -jar Bill-Service-0.0.1-SNAPSHOT.jar" ^
    ; new-tab --title "Notification Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 65 /nobreak && java %JAVA_OPTS% -jar Notification-Service-0.0.1-SNAPSHOT.jar" ^
    ; new-tab --title "Friendship Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 65 /nobreak && java %JAVA_OPTS% -jar FriendShip-Service-0.0.1-SNAPSHOT.jar" ^
    ; new-tab --title "Chat Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 70 /nobreak && java %JAVA_OPTS% -jar Chat-Service-0.0.1.jar" ^
    ; new-tab --title "Event Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 70 /nobreak && java %JAVA_OPTS% -jar Event-Service-0.0.1-SNAPSHOT.jar" ^
    ; new-tab --title "Audit Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 75 /nobreak && java %JAVA_OPTS% -jar Audit-Service-0.0.1-SNAPSHOT.jar" ^
    ; new-tab --title "Analytics Service" cmd /k "cd /d "%JAR_DIR%" && timeout /t 75 /nobreak && java %JAVA_OPTS% -jar Analytics-Service-0.0.1-SNAPSHOT.jar"
    
    echo [SUCCESS] All services are starting in Windows Terminal!
    
) else (
    echo [INFO] Windows Terminal not found. Starting services in separate windows...
    echo.
    
    REM Start services in separate command windows
    start "Eureka Server" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar eureka-server-0.0.1.jar"
    
    timeout /t 30 /nobreak
    start "API Gateway" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar gateway-0.0.1-SNAPSHOT.jar"
    
    timeout /t 20 /nobreak
    start "User Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar User-service-0.0.1.jar"
    start "Expense Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar expenses-service-0.0.1.jar"
    
    timeout /t 5 /nobreak
    start "Category Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar Category-Service-0.0.1-SNAPSHOT.jar"
    start "Payment Method Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar Payment-Method-0.0.1-SNAPSHOT.jar"
    
    timeout /t 5 /nobreak
    start "Budget Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar Budget-Service-0.0.1-SNAPSHOT.jar"
    start "Bill Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar Bill-Service-0.0.1-SNAPSHOT.jar"
    
    timeout /t 5 /nobreak
    start "Notification Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar Notification-Service-0.0.1-SNAPSHOT.jar"
    start "Friendship Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar FriendShip-Service-0.0.1-SNAPSHOT.jar"
    
    timeout /t 5 /nobreak
    start "Chat Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar Chat-Service-0.0.1.jar"
    start "Event Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar Event-Service-0.0.1-SNAPSHOT.jar"
    
    timeout /t 5 /nobreak
    start "Audit Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar Audit-Service-0.0.1-SNAPSHOT.jar"
    start "Analytics Service" cmd /k "cd /d "%JAR_DIR%" && java %JAVA_OPTS% -jar Analytics-Service-0.0.1-SNAPSHOT.jar"
    
    echo [SUCCESS] All services are starting in separate windows!
)

echo.
echo ========================================================================
echo   Startup Complete
echo ========================================================================
echo.
echo Important Service URLs:
echo   - Eureka Dashboard:  http://localhost:8761
echo   - API Gateway:       http://localhost:8080
echo   - User Service:      http://localhost:8081
echo   - Expense Service:   http://localhost:8082
echo.
echo NOTE: 
echo   - Services will take 1-2 minutes to fully start.
echo   - Check Eureka Dashboard to see when all services are registered.
echo   - Each service runs in its own window/tab.
echo   - Close the windows or press Ctrl+C to stop individual services.
echo.
echo This batch file is running from: %JAR_DIR%
"""
                    
                    // Write the batch file
                    def batFilePath = "${outputFolder}\\run-all-services.bat"
                    writeFile file: batFilePath, text: batContent
                    
                    echo "âœ… Batch file created: run-all-services.bat"
                    
                    // Create a README file
                    def readmeContent = '''# Expense Tracker - JAR Files
Generated: ''' + timestamp + '''
Location: ''' + outputFolder + '''

## Contents
This folder contains all the compiled JAR files for the Expense Tracker microservices.

## How to Run

### Quick Start
1. Double-click run-all-services.bat
2. Wait for all services to start (1-2 minutes)
3. Access Eureka Dashboard: http://localhost:8761

### What Happens
- If Windows Terminal is installed: All services open in one window with multiple tabs
- Otherwise: Each service opens in a separate command window

## Service List (14 Services)
1. Eureka Server (Service Registry) - Port 8761
2. API Gateway - Port 8080
3. User Service - Port 8081
4. Expense Service - Port 8082
5. Category Service
6. Payment Method Service
7. Budget Service
8. Bill Service
9. Notification Service
10. Friendship Service
11. Chat Service
12. Event Service
13. Audit Service
14. Analytics Service

## Prerequisites
- Java 17 or higher must be installed
- All ports must be available (not in use)

## Troubleshooting
- If a service fails to start, check if the port is already in use
- Wait for Eureka Server to fully start before other services connect
- Check individual service logs in their respective windows/tabs

## Stopping Services
- Windows Terminal: Close the entire window to stop all services
- Separate Windows: Close each window individually
- Or press Ctrl+C in each window

## Notes
- Services start with staggered delays to ensure proper initialization
- Eureka Server must start first (dependency for all other services)
- Gateway starts second (required for routing)
- All other services can start in parallel

Generated by Jenkins Build Pipeline
Build Timestamp: ''' + timestamp + '''
'''
                    
                    def readmeFilePath = "${outputFolder}\\README.txt"
                    writeFile file: readmeFilePath, text: readmeContent
                    
                    echo "âœ… README file created: README.txt"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    
                    // Save the folder path for later reference
                    env.JAR_OUTPUT_FOLDER = outputFolder
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "ğŸ§¹ CLEANUP AND FINALIZATION"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
            
            // Clean up workspace if needed
            cleanWs(
                cleanWhenNotBuilt: false,
                deleteDirs: true,
                disableDeferredWipeout: true,
                notFailBuild: true,
                patterns: [
                    [pattern: '**/target', type: 'INCLUDE'],
                    [pattern: '**/.mvn', type: 'INCLUDE']
                ]
            )
        }
        
        success {
            script {
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                 âœ… BUILD SUCCESSFUL! âœ…                    â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "ğŸ‰ All backend services built successfully!"
                echo "ğŸ“¦ Build artifacts are ready for deployment"
                echo ""
                if (env.JAR_OUTPUT_FOLDER) {
                    echo "ğŸ“‚ All JAR files copied to:"
                    echo "   ${env.JAR_OUTPUT_FOLDER}"
                    echo ""
                    echo "ğŸ’¡ You can find all JARs in your Downloads folder!"
                }
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
            
            // Archive build logs
            archiveArtifacts artifacts: '**/*.log', allowEmptyArchive: true
        }
        
        failure {
            script {
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                  âŒ BUILD FAILED! âŒ                       â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "ğŸ’¥ One or more services failed to build"
                echo "ğŸ“‹ Check the logs above for detailed error messages"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
            
            // Send notification (configure email/Slack as needed)
            // emailext (
            //     subject: "âŒ Build Failed: ${env.JOB_NAME} - #${env.BUILD_NUMBER}",
            //     body: "Build ${env.BUILD_NUMBER} failed. Check console output.",
            //     to: "${env.DEFAULT_RECIPIENTS}"
            // )
        }
        
        unstable {
            script {
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                 âš ï¸  BUILD UNSTABLE! âš ï¸                     â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "âš ï¸  Build completed with warnings"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
        }
        
        aborted {
            script {
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                  ğŸ›‘ BUILD ABORTED! ğŸ›‘                      â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "Build was manually aborted"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
        }
    }
}

// Helper function to build individual services
def buildService(String serviceName, String emoji = 'ğŸ“¦') {
    def startTime = System.currentTimeMillis()
    
    try {
        echo ""
        echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        echo "â”‚ ${emoji} Building: ${serviceName}"
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
        
        def servicePath = "${params.BACKEND_BASE_PATH}\\${serviceName}"
        echo "ğŸ“ Service Path: ${servicePath}"
        
        dir(servicePath) {
            // Check if pom.xml exists
            if (!fileExists('pom.xml')) {
                echo "âš ï¸  WARNING: No pom.xml found for ${serviceName}, skipping..."
                return
            }
            
            echo "ğŸ“ Working Directory: ${pwd()}"
            
            // Determine Maven command
            def mvnCmd = 'mvn'
            def cleanPhase = params.CLEAN_BUILD ? 'clean' : ''
            def testSkip = params.SKIP_TESTS ? '-DskipTests' : ''
            
            // Build command
            def buildCommand = "${mvnCmd} ${cleanPhase} package ${testSkip} ${MAVEN_CLI_OPTS}"
            
            echo "ğŸ”¨ Executing: ${buildCommand}"
            echo "â³ Build in progress..."
            
            // Execute build (use bat for Windows)
            def buildResult = bat(
                script: buildCommand,
                returnStatus: true
            )
            
            // Calculate build time
            def endTime = System.currentTimeMillis()
            def duration = (endTime - startTime) / 1000
            
            if (buildResult == 0) {
                echo "âœ… ${serviceName} built successfully in ${duration}s"
                
                // Check for JAR file (Windows command)
                def jarFile = bat(
                    script: "@echo off & dir /b target\\*.jar 2>nul",
                    returnStdout: true
                ).trim()
                
                if (jarFile && jarFile != '') {
                    echo "ğŸ“¦ Artifact: ${jarFile}"
                }
                
                echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            } else {
                echo "âŒ ${serviceName} build FAILED after ${duration}s"
                echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                error("Build failed for ${serviceName}")
            }
        }
    } catch (Exception e) {
        echo "ğŸ’¥ ERROR in ${serviceName}: ${e.getMessage()}"
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
        throw e
    }
}

// Helper function for logging with levels
def log(String level, String message) {
    def timestamp = new Date().format('yyyy-MM-dd HH:mm:ss')
    def levelEmoji = [
        'DEBUG': 'ğŸ›',
        'INFO': 'â„¹ï¸',
        'WARN': 'âš ï¸',
        'ERROR': 'âŒ',
        'SUCCESS': 'âœ…'
    ]
    
    echo "[${timestamp}] ${levelEmoji[level] ?: 'ğŸ“'} [${level}] ${message}"
}
